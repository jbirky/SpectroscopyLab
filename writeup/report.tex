\documentclass[preprint]{aastex62}

% \usepackage{minted}
\usepackage{amsmath}
\usepackage{listings}
\usepackage{courier}
\usepackage{cleveref}
\usepackage{float}

\definecolor{bcolor}{RGB}{0, 51, 153}
\definecolor{gcolor}{RGB}{51, 153, 51}

\shorttitle{astronomical spectroscopy}
\shortauthors{j. birky}

\begin{document}

\title{\sc Lab 2: Astronomical Spectroscopy}
\author{Jessica Birky, Julian Beas-Gonzalez, Russell Van-Linge}

\correspondingauthor{Jessica Birky (A13002163)}
\email{jbirky@ucsd.edu}

\begin{abstract}
In this lab we determine the wavelength calibration for two different spectrographs: the Ocean Optics USB 2000 fiber optic spectrograph, and the KAST spectrograph mounted at Lick Observatory. Using spectra of several gas lamps (Helium, Neon, and HeHgCd), we compare the pixel values of emission centroids to theoretical emission wavelengths to determine pixel-to-wavelength conversion solutions of $\lambda=.3568(\mathrm{pixel})+344.21$ nm for the Ocean Optics instrument and  $\lambda=.1549(\mathrm{pixel})+329.25$ nm, using linear least-squares regression. We also compute the errors for each emission peak, and find that the error roughly decreases by a 1/$\sqrt{n}$ trend, with higher lower intensity peaks having higher errors. Finally, applying our calibration to spectra from several different light sources (incandescent and fluorescent bulbs) and astronomical sources (the Sun, BD+15233, Feige 110, and J0047+0319) we draw conclusions about how these spectra were formed based off of Kirchoff's laws of spectral formation.

\end{abstract}
\bigskip

\section{Introduction} 
% Astronomical spectroscopy, components of spectrographs, types of spectrographs
A spectrum measures the flux of photons coming from a source as a function of wavelength. Kirchoff's laws of spectral formation characterizes the three different ways a spectrum can be created: (1) a hot opaque body or dense gas (such as a black body) will produce a continuous spectrum; (2) a hot transparent, low-density gas will produce an emission line spectrum; and (3) a cool, transparent, low-density gas will produce an absorption line spectrum.

In Lab 1 we learned about the properties of charged coupled device (CCD) detectors, and how we can measure the number of photon counts over two spatial dimensions. This lab add several other layers of instrumentation which allow us to disperse light taken over a narrow slit across a region of wavelengths, producing a two-dimensional (1 spatial dimension $\times$ 1 wavelength dimension) image of a source. \color{red}{gratings/grisms, collimator, detector setup...}\color{black}

In particular, this lab seeks to classify several different types of spectrum taken from every day sources (such as incandescent/fluorescent lights and the Sun), gas lamps (such as Helium, Neon, and HeHgCd gas), and several astronomical sources.
Section \ref{sec:observations} covers the particular schematics and specifications of two different spectrographs: the Ocean Lab spectrometer (which we use to take the spectra of every day sources), and the KAST spectrograph mounted on the Shane 3m Telescope on Lick Observatory (which we use to study astronomical sources). 


% ==================================
\section{Observations} \label{sec:observations}
% Describe ocean lab and KAST spectrographs specifications and diagrams
\subsection{Spectrographs}
The KAST spectrograph has two different observing modes: a red arm and a blue arm.

\begin{figure}[H]
\begin{center}
\includegraphics[width=.49\linewidth]{plots/oceanlab_schematic.jpeg}
\includegraphics[width=.49\linewidth]{plots/kast_schematic.png} 
\caption{Schematic of two spectrographs: Ocean Optics USB 2000 (left) and KAST (right).}
\end{center}
\end{figure}

\subsection{Data Collection}
Using the Ocean lab spectrometer we collected spectra of five different sources: the sun, an incandescent light bulb, a fluorescent light bulb, a helium gas lamp, and a neon gas lamp, as well as bias frames taken in a dark room. For each source we colleced 100 frames of data.

We also analyzed several astronomical spectra taken with KAST in 2013. Reduction for the KAST spectrograph requires three types of frames: the scientific frames, as well as bias frames (a zero second exposure capturing instrumental noise), and flat field frames (measuring the pixel-to-pixel
response from the detector due to variations in quantum efficiency or optical path differences in the system) which are used for calibration. Table \ref{table:log} shows the observation log of frames used from the Shane public data repository.

\begin{table}[H]
    \begin{center}
    \begin{tabular}{|c|c|c|c|c|c|}
    \hline
    source     & RA       & DEC      & frame \# & \# frames & exposure time (sec) \\
    \hline \hline
    HeHgCd arclamp &     --   &    --    & 100      & 1         & 40                  \\
    bias       &    --    &     --   & 101-110  & 10        & 0                   \\
    flat field &    --    &     --   & 121-150  & 30        & 90                  \\
    J0047+0319 & 0:47:34  & 3:25:55  & 155      & 1         & 1200                \\
    BD+15233   & 1:34:31  & 15:51:42 & 156      & 1         & 90                  \\
    Feige 110  & 23:20:35 & -5:02:03 & 160      & 1         & 120                 \\
    \hline     
    \end{tabular}
    \end{center}
\caption{Observation log of bias, flat field and science frames taken on KAST. Frame 100 arclamp is used for wavelength calibration, frame 101-110 bias frames are used for subtracting instrument noise, frame 121-150 dome flat frames are used for calibrating detector sensitivity at each pixel, and frames 155, 156, and 160 are three different astronomical sources.} \label{table:log}
\end{table}

% ==================================
\section{Data Reduction \& Methods} \label{sec:methods}
% Centroid routine, wavelength calibration, centroid error and calibration error
% Bias subtraction and normalization
\subsection{Reduction}
For the Ocean Lab spectra, using the same procedure as Lab 1, we combined all 100 bias frames by taking the median at each pixel. Then for each frame of the solar, lamp spectras we subtracted the bias and combined into one reduced frame (lines $4-19$, Section \ref{code:reduction}).

Reducing the KAST data to extract 1D spectrum arrays required several steps: (1) we combined all 10 bias frames (listed in Table \ref{table:log}) by taking the median value at each pixel (lines $15-19$ Section \ref{code:reduction}); (2) we computed the normalized flat image (lines $21-33$): 
\begin{equation}
    {\rm Flat_{norm} = (Dome - Bias)/Median(Dome - Bias)} 
\end{equation}
(3) we bias-subtracted the arclamp, dome flat, and science images, and divided each by the normalized flat field (lines $35-49$); (4) we sliced the 2D image along the spatial dimension to extract the region that contains the source and took the average across the spatial dimension to produce a 1D spectrum (photon counts in ADU vs. wavelength pixel index) shown in lines $51-62$.


\subsection{Wavelength Calibration}
The spectrograph outputs the photon counts as a function of wavelength in arbitrary pixel units, however we want to know the spectrum as a function of its electromagnetic wavelength. In order to do this we must come up with a function that converts pixel to wavelength. This is why we collect emission spectra of several gas lamps: if we know the pixel values of each emission peak, and we can theoretically compute the wavelength produced by an electron transition, then we can match pixel peaks to wavelength peaks and calibrate a solution.

In this lab, we test a first-order polynomial fit ($y=mx+c$), which as we will see in the next section looks to describe the correlation well. Using least-squares regression we can fit the slope and intercept between our pixel array ($x$) and our wavelength array ($y$), each which contain $N$ elements. The best fit slope, intercept and fit errors are complete linear algebra operations to compute. Lines $1-20$ of Section \ref{code:wavecal} show the implementation of the following parameter and error equations:

\begin{equation}
\begin{bmatrix}
    m \\ c
\end{bmatrix}
= 
\begin{bmatrix}
    \sum x_i^2 & \sum x_i \\
    \sum x_i & N
\end{bmatrix}^{-1}
\begin{bmatrix}
    \sum x_i y_i \\ \sum y_i
\end{bmatrix}
\end{equation}

\begin{equation}
    \sigma^2 = \frac{1}{N-2}\sum_i [y_i - (mx_i + c)]^2
\end{equation}
\begin{equation}
    \sigma_m^2 = \frac{N\sigma^2}{N\sum_i x_i^2 - \left(\sum_i x_i \right)^2}
\end{equation}
\begin{equation}
    \sigma_c^2 = \frac{\sigma^2 \sum_i x_i^2}{N\sum_i x_i^2 - \left(\sum_i x_i \right)^2}
\end{equation}

Two separate calibrations are performed for the Ocean Optics and KAST spectrographs. For the Ocean Optics we calibrate using Helium and Neon emission spectra, and for KAST we use the HeHgCd arclamp spectrum.

\subsection{Centroid Indentification Routine}
Lines $1-33$ of \ref{code:centroid} show our routine for indetifying emission features. The input to the function is a 2D array where the first element is the pixel array, and the second element is the photon count array. Given a certain `threshold' value the code finds the indices of all points that lie above a median + threshold*(standard deviation) cut (lines $17-20)$. From there it groups all indices into separate arrays if they are sequential (lines $22-31$), so each array represents a set of indices for one emission feature. To remove small noisy features and only keep those that are signficant, we require that the length of the array my be at least 5 pixels long to be included. We also attempted other methods to indentify centroids, such as taking the slope between adjacent points and finding the points where the slope significantly changes from positive to negative, however we ran into a lot of difficulty deciphering between noise and actual emissions, separating double peaked features, and automating how to find the base of the feature, and so we abandoned this method.

Lines $39-50$ of \ref{code:centroid} shows the implementation of how we find the centroids and compute the root mean squared (rms) width and error of each emission:
\begin{equation}
    x_{\rm centroid} = \langle x \rangle = \frac{\sum_i x_i I_i}{\sum_i I_i} 
\end{equation}
\begin{equation}
    s^2 = \frac{\sum_i (x_i - \langle x \rangle)^2 I_i}{\sum_i I_i} = \langle x^2 \rangle - \langle x \rangle^2
\end{equation}
Propagating the error for $\langle x \rangle$ as a function of each pixel and assuming Poisson statistics for the intensity distribution we can determine $\sigma_{\langle x \rangle}^2$:
\begin{align}
    \sigma_{\langle x \rangle}^2 
    &= \sigma_{I_1}^2 \left(\frac{\partial \langle x \rangle}{\partial I_1} \right)^2
    + ... + \sigma_{I_N}^2 \left(\frac{\partial \langle x \rangle}{\partial I_N} \right)^2
    = \sum_i \sigma_{I_i}^2 \left(\frac{\partial \langle x \rangle}{\partial I_i} \right)^2 \\
    &= \frac{\sum_j I_j (x_j - \langle x \rangle)^2}{\left(\sum_i I_i \right)^2}
\end{align}

% \begin{figure}[H]
% \plotone{plots/helium_reference.png}
% \caption{\href{https://www.vernier.com/innovate/a-quantitative-investigation-of-the-helium-spectrum/}{https://www.vernier.com/innovate/a-quantitative-investigation-of-the-helium-spectrum/}} \label{fig:bias}
% \end{figure}

% ==================================
\section{Data Analysis \& Modeling} \label{sec:analysis}
Show centroids, wavelength calibration plots, application of wavelength solution, plots of astronomical spectra

\begin{table}[H]
    \begin{center}
    \begin{tabular}{|c|c|c|c|c|}
    \hline
    spec\_pixel & spec\_intensity (ADU) & nist\_wave (nm) & nist\_intensity & gas element \\
    \hline \hline
    132.3649283 & 236.48          & 388        & 60-300          & He      \\
    288.9587617 & 249.46          & 447        & 25-200          & He      \\
    412.1908462 & 98.46           & 492        & 20              & He      \\
    437.7643945 & 271.16          & 501        & 100             & He      \\
    677.5521828 & 3106.25         & 588        & 120-500         & He      \\
    908.0143522 & 564.74          & 668        & 200             & He      \\
    1021.697778 & 867.6           & 706        & 20-100          & He      \\
    673.712     & 1696.45         & 585.25     & 200             & Ne      \\
    700.126     & 617.38          & 594.48     & 50              & Ne      \\
    722.492     & 181.31          & 602.99     & 100             & Ne      \\
    747.974     & 1339.68         & 614.3      & 100             & Ne      \\
    775.796     & 290.88          & 621.73     & 100             & Ne      \\
    820.02      & 3428.72         & 640.22     & 200             & Ne      \\
    860.822     & 1265.04         & 650.65     & 150             & Ne      \\
    886.09      & 419.28          & 659.9      & 100             & Ne      \\
    913.44      & 767.24          & 667.82     & 50              & Ne      \\
    982.83      & 635.18          & 692.94     & 1000            & Ne      \\
    1013.238    & 834.96          & 705.91     & 100             & Ne      \\
    1134.814    & 80.86           & 748.87     & 300             & Ne      \\
    \hline
    \end{tabular}
    \end{center}
\end{table}

\begin{table}[H]
    \begin{center}
    \begin{tabular}{|c|c|c|c|}
    \hline
    spec\_pixel & spec\_intensity & ref\_wave & gas molecule \\
    \hline \hline
    23.50092286 & 30772.15763     & 326.105   & HeHgCd  \\
    184.1577234 & 37829.79081     & 361.051   & HeHgCd  \\
    229.5492333 & 40120.66215     & 365.015   & HeHgCd  \\
    477.9985327 & 11444.21891     & 404.656   & HeHgCd  \\
    639.6619601 & 30172.47648     & 435.833   & HeHgCd  \\
    949.4331504 & 35609.38425     & 479.992   & HeHgCd  \\
    1257.08592  & 5622.686548     & 505.882   & HeHgCd  \\
    1372.254406 & 10136.48802     & 546.074   & HeHgCd  \\
    1638.903321 & 10132.41605     & 587.562   & HeHgCd  \\
    \hline
    \end{tabular}
    \end{center}
\end{table}



% ==================================
\section{Discussion} \label{sec:discussion}
% What kind of astronomical sources
As seen in Figure , the solar spectrum and lamp spectrum show the approximate profile of a blackbody. Blackbody radiation
\begin{equation}
    B_{\lambda}(T) = \frac{hc^3}{\lambda^5}\frac{1}{e^{hc/\lambda k_b T} - 1}
\end{equation}

% ==================================
\section{Conclusion}


% ==================================
\section{Author Contributions}
This project was done in collaboration with Julian Beas-Gonzalez and Russell Van-Linge (Group
E), and we divided the tasks for this lab. I worked on writing a routine to isolate arrays that contain emission features in the gas lamp spectra, match lines to the Helium and HeHgCd spectra, and perform and apply the wavelength calibration using linear regression. Julian worked on computing the centroids and errors (including improving the code to get sub-pixel centroids), and matching lines to the Neon spectrum for calibration. Russell worked on reducing the 2D KAST images (bias subtraction, normalization, and slicing) to produce 1D spectra, and tested alternative centroid identification methods. Besides manually matching arclamp centroids to NIST/template spectrum, our code is fully automated.

% ===================
% Figures
\begin{figure}[H]
\begin{center}
\includegraphics[width=.8\linewidth]{plots/kast_science_imgs.png} 
\caption{Bias-subtracted, normalized, 2D images of three different spectra taken on the KAST spectrograph: BD+15233, Feige 110, and J0047+0319. X-axis shows the wavelength dimension, y-axis shows the spatial dimension. Horizontal white line marks the source, and vertical white lines mark emission features in Earth's atmosphere. Dark bands across the source are absorption features.} \label{fig:science_images}
\end{center}
\end{figure}

% ===================
\begin{figure}[H]
\begin{center}
\includegraphics[width=.49\linewidth]{plots/oceanlab_helium_thres.png}
\includegraphics[width=.49\linewidth]{plots/oceanlab_neon_thres.png} \\
\includegraphics[width=.49\linewidth]{plots/oceanlab_helium_centroids.png}
\includegraphics[width=.49\linewidth]{plots/oceanlab_neon_centroids.png} \\
\includegraphics[width=.49\linewidth]{plots/kast_arclamp_thres.png} \\
\includegraphics[width=.49\linewidth]{plots/kast_arclamp_centroids.png} 
\caption{Centroid finding routine.} \label{fig:centoid}
\end{center}
\end{figure}

% ===================
\begin{figure}[H]
\begin{center}
\includegraphics[width=.46\linewidth]{plots/oceanlab_wavecal.png}
\includegraphics[width=.46\linewidth]{plots/oceanlab_residual.png}
\caption{Wavelength calibration for the Ocean Optics spectrometer. Here we determine the pixel-to-wavelength conversion to be $\lambda=.3568(\mathrm{pixel})+344.21$ nm (left). Lack of obvious correlations in the residual plot (right) indicates that a first order polynomial fit is sufficient for describing the wavelength-pixel relationship.} \label{fig:oceanlab_wavecal}
\end{center}
\end{figure}

\begin{figure}[H]
\begin{center}
\includegraphics[width=.46\linewidth]{plots/kast_wavecal.png}
\includegraphics[width=.46\linewidth]{plots/kast_residual.png}
\caption{Wavelength calibration for the KAST spectrometer. Here we determine the pixel-to-wavelength conversion to be $\lambda=.1549(\mathrm{pixel})+329.25$ nm (left). Lack of obvious correlations in the residual plot (right) indicates that a first order polynomial fit is sufficient for describing the wavelength-pixel relationship.} \label{fig:kast_wavecal}
\end{center}
\end{figure}

% ===================
\begin{figure}[H]
\begin{center}
\includegraphics[width=.46\linewidth]{plots/oceanlab_error_vs_intensity2.png}
\includegraphics[width=.46\linewidth]{plots/oceanlab_error_vs_intensity.png}
\caption{Error vs. Intensity at centroid of each identified emission peak. We see that the majority of point generally appear to lie along 1/$\sqrt{n}$ pattern, with some outliers.} \label{fig:error_vs_intensity}
\end{center}
\end{figure}

% ===================
% Science images
\begin{figure}[H]
\begin{center}
\includegraphics[width=.31\linewidth]{plots/oceanlab_solar.png}
\includegraphics[width=.31\linewidth]{plots/oceanlab_fluorescent.png}
\includegraphics[width=.31\linewidth]{plots/oceanlab_lamp.png}
\caption{Three spectra taken on the Ocean Lab Spectrometer: the Sun, a fluorescent light bulb, and an incandescent lamp. Wavelength scale determined by calibration with emission centroids in Helium and Neon lamps to known emission peaks from the NIST atomic line database.} \label{fig:oceanlab_specs}
\end{center}
\end{figure}

\begin{figure}[H]
\begin{center}
\includegraphics[width=.31\linewidth]{plots/kast_bd15233.png}
\includegraphics[width=.31\linewidth]{plots/kast_feige110.png}
\includegraphics[width=.31\linewidth]{plots/kast_j00470319.png}
\caption{Three astronomical spectra taken on the KAST spectrograph: BD+15233, Feige 110, and J0047+0319.  Wavelength scale determined by calibration with emission centroids in HeHgCd arclamp spectra.} \label{fig:kast_specs}
\end{center}
\end{figure}
% ==================================
\newpage
\section{Appendix}

\lstset{language=Python,
        basicstyle=\footnotesize\ttfamily,
        keywordstyle=\color{blue},
        numbers=left,
        numberstyle=\ttfamily,
        stringstyle=\color{red},
        commentstyle=\color{gcolor},
        morecomment=[l][\color{gray}]{\#}
}

\vspace{7pt} \hrule \vspace{7pt}
\subsection{Centroid Identification Routine} \label{code:centroid}
\small
\hrule
\begin{lstlisting}
def emission(data, **kwargs):
    """
    Input:  'data': 2D array [x,y]
            'thres': standard deviation threshold
    Output: 'emission': an array of arrays which contain the index of 
                each emission which lies above some threshold cut
    """
    thres = kwargs.get('thres', 1)
    
    x, y = np.array(data[0]), np.array(data[1])
    Npix = len(x)
    
    med = np.median(y)
    std = np.std(y)
    cut = med + thres*std
    
    count_cut = []
    for i in range(Npix):
        if y[i] >= cut:
            count_cut.append(i)
    
    emission = []
    arr = []
    for i in range(len(count_cut)-1):
        if (count_cut[i+1] - count_cut[i]) == 1:
            arr.append(count_cut[i])
        else:
            arr.append(count_cut[i])
            if len(arr) > 5:    # only keep arrays that have >5 pixels
                emission.append(np.array(arr))
            arr = []

return np.array(emission)

"""
Produces float values for the centroids, calculating their error and width
Credit: Julian
"""
centroids, errors, widths, intensities = [], [], [], []
for i in np.arange(len(cent)):
    inte = []
    for a in emiss[i]:
        inte.append(data[1][a])
    centr_f = sum(emiss[i]*inte)/sum(inte)
    err_f = sum(inte*((emiss[i]-centr_f)**2))/(sum(inte))**2
    width_f = sum(inte*((emiss[i]-centr_f)**2))/sum(inte)
    
    centroids.append(centr_f)
    errors.append(err_f)
    widths.append(width_f)
    intensities.append(max(data[1][emiss[i]]))
\end{lstlisting}
\hrule \vspace{7pt}


\subsection{Wavelength Calibration} \label{code:wavecal}
\small
\hrule
\begin{lstlisting}
def linear_regression(x, y):
    """
    Input:  x, y: 1D arrays
    Output: [m, c], [m_err, c_err]: slope and intercept best fit and error
    """
    N = len(x)
    x, y = np.array(x), np.array(y)

    A = np.array([[np.sum(x**2), np.sum(x)], \
                  [np.sum(x), N]])
    a = np.array([np.sum(x*y), np.sum(y)])

    fit = np.dot(np.linalg.inv(A), a)

    sig_sq = np.sum(y - (fit[0]*x + fit[1]))**2/(N + 2)
    m_err = np.sqrt(N*sig_sq/(N*np.sum(x**2) - (np.sum(x))**2))
    c_err = np.sqrt(sig_sq*np.sum(x**2)/(N*np.sum(x**2) - (np.sum(x))**2))
    err = np.array([m_err, c_err])

    return fit, err
\end{lstlisting}
\hrule \vspace{7pt}


\subsection{KAST Data Reduction} \label{code:reduction}
\small
\hrule
\begin{lstlisting}
"""
Credit: Russell
"""
def readData(folder):
    '''
    Reads all the fits files in a folder and creates a 3D array
    '''
    files = os.listdir(folder)
    array3D = []
    for ff in files:
        arr = fits.getdata(folder+ff,ignore_missing_end=True)
        array3D.append(arr)
    return np.array(array3D)

def combineFrame(data_array):
    '''
    Avergaes the 3D into 2D array
    '''
    return np.median(data_array,axis=0)
    
def norm_flat(bias_folder,flat_folder):
    '''
    Input the bias and flat folders and creates
    bias,flats, and normalized flats
    '''
    flat3d = readData(flat_folder)
    bias3d = readData(bias_folder)

    flat2d = combineFrame(flat3d)
    bias2d = combineFrame(bias3d)

    norm_flat = (flat2d-bias2d)/np.median(flat2d-bias2d)
    return norm_flat,flat2d,bias2d

def science_image(science_folder,flat_folder,bias_folder):
    '''
    Creates a science image and outputs the 2D array to be used to make spectra
    '''
    # create flats and bias
    normflat, flat, bias = norm_flat(bias_folder,flat_folder) 

    science_3d = readData(science_folder) # reducing down to 2d 
    science_2d = combineFrame(science_3d)
    science_final = (science_2d - bias)/normflat # subtracting bias and normalizing
    # Plots the science image
    plt.imshow(science_final,origin='lower',interpolation='nearest',\
        cmap='gray',vmin=10,vmax=1000)
    plt.show()
    return science_final

def science_spectra(science_2d,start_slice,end_slice,file_name='file_name'):
    '''
    Creates a spectra by slicing up the science image at the input spatial
    pixels, saves array, and outputs plot
    '''
    spectra = np.mean(science_2d[start_slice:end_slice,:],axis=0)
    spectra = spectra[spectra>0]
    x = np.arange(0,len(spectra))
    plt.plot(x,spectra,color='black')
    plt.show()
    np.save('%s_spectra'%file_name,science_2d)
    return spectra
\end{lstlisting}
\hrule \vspace{7pt}



\end{document}

